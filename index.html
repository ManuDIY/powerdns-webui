<!--- (c) Copyright 2019, James Stevens ... see LICENSE for details --->
<!--- Alternative license arrangements are possible, contact me for more information --->
<html>
<style type='text/css'>

html {
	color: black;
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-size:10pt;
	background-color:#666688;
	scrollbar-base-color:#666699;
	scrollbar-arrow-color:#ddddff;
	}

select {
	color: black;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 8pt;
	}

input {
	color: black;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 8pt;
	}

body {
	color: black;
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-size:10pt;
	background-color:#666688;
	scrollbar-base-color:#666699;
	scrollbar-arrow-color:#ddddff;
	}

a {
	color: darkblue;
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-weight:normal;
	font-size:10pt;
	text-decoration:none;
	}

a:hover {
	color:darkblue;
	text-decoration: underline;
	} 

form {
	margin:0px;
	}

.topBlob {
	display: inline-block;
	background-color: #d0d0ff;
	color: black;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 10pt;
	font-weight: bold;
	border-radius: 25px;
	padding: 5px;
	padding-left: 10px;
	padding-right: 10px;
	cursor: pointer;
	margin-left: 10px;
	}

td {
	padding-left: 7px;
	padding-right: 7px;
	white-space: nowrap;
	}

.zoneListItem {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 10pt;
	cursor: pointer;
	color: white;
	background-color: #666688;
	}

.zoneListItem:hover {
	background-color: #444466;
	}


.formPrompt {
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-size:10pt;
	color: white;
	text-align: right;
	}

</style>

<script language="Javascript">

console.clear()

var gbl = {
	server: null,
	apikey: null,
	with_https: true,
	thisZone: null,

	tick: "&#x2611;",
	cross: "&#x2612;",
	timer: "&#x23f3;",
	bin: "&#x1f5d1;",
	};

var ctx = {
	};



function callApiGet(sfx,callback)
{
	showLoading();

	p = "https"
	if (!gbl.with_https) p = "http"
	url = p + "://" + gbl.server + "/api/v1/servers/localhost/" + sfx

	http_cmd = {
		headers: {
			'X-API-Key': gbl.apikey,
			},
		method: 'GET',
		};

	fetch(url,http_cmd).then(function(response) {
		if (response.status !== 200) {
			gbl.bot.innerHTML("ERROR: "+response.status);
			return;
			}

		response.json().then(function(data) { callback(data); });

		}).catch(function(err) {
			console.log('Fetch Error :-S', err);
			}
		);
}


//=============================================================================================
// Zone META data handling
//=============================================================================================

function zoneMeta()
{
	ctx.meta = true; topLine();
	callApiGet("zones/"+ctx.zone+"/metadata",zoneMetaDetails);
	return false;
}



function zoneMetaDetailsHTML(item)
{
	x = "<tr class=zoneListItem>"
		+ "<td>" + item.kind + "</td>"
		+ "<td>";
	for(i of item.metadata) x = x + i + "<br>";
	return x + "</td></tr>";
}



function zoneMetaDetails(data)
{
	data.sort(function(a,b) {
		if (a.kind < b.kind) return -1;
		if (a.kind > b.kind) return 1;
		return 0;
		})
	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data) x = x + zoneMetaDetailsHTML(i);
	gbl.bot.innerHTML = x + "</table>";
}



//=============================================================================================
// Zone Details Handling
//=============================================================================================

function saveRRChanges(withSave)
{
	if (withSave) {
		for(idx in ctx.rrs.records) {
			console.log(idx,ctx.rrs.records[idx]);
			}
		}
	delete ctx.needSave;
	delete ctx.idx;
	topLine();
	getZoneRecord();
}



function changeRR()
{
	new_val = document.rrForm.new.value;

	if (new_val != ctx.rrs.records[ctx.idx].content) {
		ctx.needSave = "saveRRChanges";
		ctx.rrs.records[ctx.idx].content = new_val;
		s = document.getElementById("rrs"+ctx.idx);
		s.innerHTML = new_val;
		}

	delete ctx.idx;
	delete ctx.needCancel;
	topLine();

	return false; // cancel the form submit
}



function clickRR(idx)
{
	s = document.getElementById("rrs"+idx);
	if (s.innerHTML.indexOf("<form") >= 0) return;

	if ("idx" in ctx) {
		drawOneRecord();
		s = document.getElementById("rrs"+idx);
		}

	ctx.idx = idx

	x = "<form onSubmit='return changeRR("+idx+");' name=rrForm>"
		+ "<input size=50 name=new value=\""+ctx.rrs.records[idx].content+"\">"
		+ "</form>";

	s.innerHTML = x;
	document.rrForm.new.focus();
	ctx.needCancel = "editNoRR";
	topLine();
}



function editNoRR()
{
	if (!("idx" in ctx)) return;
	s = document.getElementById("rrs"+ctx.idx);
	s.innerHTML = ctx.rrs.records[ctx.idx].content;
	delete ctx.idx;
	delete ctx.needCancel;
	topLine()
}



function deleteRRitem(idx)
{
	if ("idx" in ctx) return editNoRR()
	delete ctx.rrs.records[idx]
	ctx.needSave = "saveRRChanges"
	topLine()
	drawOneRecord()
}



function oneRecordHTML(idx)
{
	i = ctx.rrs.records[idx];
	x = "<tr class=zoneListItem>"
		+ "<td width=10% onClick='deleteRRitem("+idx+");' align=center>" + gbl.bin + "</td>"
		+ "<td width=25% onClick='editNoRR();'>" + ctx.rrs.name + "</td>"
		+ "<td valign=top align=right>" + ctx.rrs.ttl + "</td>"
		+ "<td valign=top>" + ctx.rrs.type + "</td>"
		+ "<td onClick='clickRR("+idx+");' width=60%><span id=rrs"+idx+">" + i.content + "</span></td>";
	return x + "</tr>";
}



function oneRecord(data)
{
	if (data.id != ctx.zone)
		return showError("ERROR: Zone does not match loaded data");

	findrec = function() {
		for(tag of data.rrsets)
			if ((tag.name == ctx.name)&&(tag.type == ctx.type)) return tag;
		return null; }

	rrs = findrec();

	if (rrs == null)
		return showError("ERROR: Data for "+name+" not returned");

	rrs.records.sort(function(a,b) {
		if (a.content < b.content) return -1;
		if (a.content > b.content) return 1;
		return 0;
		})

	ctx.rrs = rrs

	drawOneRecord()
}



function drawOneRecord(rrs)
{
	delete ctx.idx
	x = "<table width=100% border=0 cellspacing=1 cellpadding=0>";
	for(idx in ctx.rrs.records) 
		x = x + oneRecordHTML(idx);
	gbl.bot.innerHTML = x + "</table>";
}



function clickZoneRecord(name,type)
{
	ctx.name = name;
	ctx.type = type;
	delete ctx.meta;
	getZoneRecord();
}


function getZoneRecord()
{
	delete ctx.needSave;
	topLine();
	callApiGet("zones/" + ctx.zone,oneRecord);
}



function zoneDetailsHTML(zone,item)
{
	x = "<tr onClick=\"clickZoneRecord('"+item.name+"','"+item.type+"');\" class=zoneListItem>"
		+ "<td valign=top>" + item.name.substr(0,item.name.length - zone.length - 1) + "</td>"
		+ "<td valign=top align=right>" + item.ttl + "</td>"
		+ "<td valign=top>" + item.type + "</td>"
		+ "<td valign=top>"

	if (item.type == "SOA")
		x = x + formatSOA(item.records[0].content);
	else {
		item.records.sort(function(a,b) {
			if (a.content < b.content) return -1;
			if (a.content > b.content) return 1;
			return 0;
			})

		for(rrs of item.records) 
			x = x + "" + rrs.content + "<br>";
		}
	return x + "</td></tr>";
}



function zoneDetails(data)
{
	data.rrsets.sort(function(a,b) {
		if ((a.name == data.id)&&(b.name == data.id)) {
			for(tag of ["SOA","NS","MX"]) {
				if (a.type == tag) return -1;
				if (b.type == tag) return 1;
				}
			}
		else {
			if (a.name == data.id) return -1;
			if (b.name == data.id) return 1;
			if (a.name < b.name) return -1;
			if (a.name > b.name) return 1;
			}
		if (a.type < b.type) return -1;
		if (a.type > b.type) return 1;
		return 0;
		})

	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data.rrsets) x = x + zoneDetailsHTML(data.id,i);
	gbl.bot.innerHTML = x + "</table>";
}



function zoneDetailsLoad(zone)
{
	ctx = { zone: zone };
	topLine();
	getZoneDetails();
}


function getZoneDetails()
{
	callApiGet("zones/" + ctx.zone,zoneDetails);
}



//=============================================================================================
// Search handling code
//=============================================================================================

function searchResultsHTML(item)
{
	x = "<tr class=zoneListItem";
	if (item.object_type != "zone") {
		x = x + "><td valign=top>" + item.name + "</td>"
			+ "<td valign=top align=right>" + item.ttl + "</td>"
			+ "<td valign=top>" + item.type + "</td>";

		if (item.type == "SOA")
			x = x + "<td valign=top>" + formatSOA(item.content) + "</td>";
		else
			x = x + "<td valign=top>" + item.content + "</td>"; }

	else {
		x = x + " onClick='return zoneDetailsLoad(\""+item.name+"\");'>";
		x = x + "<td>" + item.name + "</td><td colspan=3>[Zone Apex]</td>";
		}
	return x + "</tr>";
}



function searchResults(data)
{
	ctx = {}; topLine();
	if (data.length <= 0) {
		gbl.bot.innerHTML = "No search results";
		return;
		}

	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data) x = x + searchResultsHTML(i);
	gbl.bot.innerHTML = x + "</table>";
}



function searchFormSubmit()
{
	s = document.searchForm.searchTerm.value;
	document.searchForm.searchTerm.value = "";
	callApiGet("search-data?q=" + s,searchResults);
	return false;
}



//=============================================================================================
// Code to handle the list of zones
//=============================================================================================

function zoneListDetailsHTML(item) 
{
	name = item.id;
	x = "<tr class=zoneListItem onClick='zoneDetailsLoad(\""+name+"\")'>"
		+ "<td>" + name + "</td>"
		+ "<td>" + item.kind + "</td>";
	if (item.dnssec) t = gbl.tick; else t = gbl.cross;
	x = x + "<td>" + t + "</td>"
		+ "<td>" + item.serial + "</td>";
	if (item.notified_serial == item.serial) t = gbl.tick; else t = gbl.cross;
	x = x + "<td>" + t + "</td>";
	return x + "</tr>";
}



function zoneListDetails(data)
{
	data.sort(function(a,b) {
		if (a.id < b.id) return -1;
		if (a.id > b.id) return 1;;
		return 0;
		})

	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data) x = x + zoneListDetailsHTML(i);
	gbl.bot.innerHTML = x + "</table>";
}



function zoneList()
{
	ctx = { }; topLine();
	callApiGet("zones",zoneListDetails);
	return false;
}



//=============================================================================================
// Common functions
//=============================================================================================


function btn(call,txt) {
	return "<span class=topBlob onClick='"+call+"; return false;'>"+txt+"</span>"
}



function topLine()
{
	x = "<table border=0 cellspacing=0 cellpadding=0 width=100%><tr><td width=100%>"
		+ btn("location.reload()",gbl.server) + btn("zoneList()","Zones");

	if ("zone" in ctx) {
		x = x + btn('getZoneDetails()',ctx.zone)
		if (("name" in ctx)&&("type" in ctx))
			x = x + btn('getZoneRecord()',ctx.name+'/'+ctx.type);
		else {
			if ("meta" in ctx)
				x = x + btn('zoneMeta()',"META");
			else
				x = x + "</td><td>" + btn('zoneMeta()',"META");
			}
		}

	if ("needCancel" in ctx)
		x = x + "</td><td>"
			+ btn(ctx.needCancel+"(false)","Cancel");
	else if ("needSave" in ctx)
		x = x + "</td><td>"
			+ btn(ctx.needSave+"(false)","Cancel")
			+ btn(ctx.needSave+"(true)","Save");

	x = x + "</td><td width=1 align=right><form name=searchForm onSubmit='return searchFormSubmit();'>"
		+ "<input placeholder='Search' size=40 name=searchTerm></form></td>"
		+ "</tr><table><hr>";

	gbl.top.innerHTML = x;
}



function startUp()
{
	gbl.top = document.getElementById("topSpan");
	gbl.bot = document.getElementById("lowerSpan");
}



function initialLogin()
{
	f = document.loginForm;
	gbl.server = f.server.value;
	gbl.apikey = f.apikey.value;
	gbl.with_https = f.with_https.checked;
	zoneList();
}



function formatSOA(soa_txt)
{
	i = soa_txt.split(" ");
	soa = i[0] + " " + i[1] + "<br>";
	idx = 2;
	for(tag of ["serial","refresh","retry","expire","minimum"]) {
		soa = soa + "<span style='display: inline-block; width:50px'></span>";
		soa = soa + "<span style='display: inline-block; width:100px'>" + i[idx++] + "</span>;" + tag + "<br>";
		}
	return soa;
}



function showError(err)
{
	gbl.bot.innerHTML = "<h1>"+err+"</h1>";
}



function showLoading()
{
	gbl.bot.innerHTML = "<h1>Loading... "+gbl.timer+"</h1>";
}




//=============================================================================================
</script>



<body onLoad="startUp();">
<span id="topSpan"></span>
<span id="lowerSpan">
	<table align=center>
	<form action="/" name=loginForm>
		<tr>
		<tr><td class=formPrompt>Server:</td><td><input name=server value="pdnsdev.jrcs.net"></td></tr>
		<tr><td class=formPrompt>Key:</td><td><input type=password name=apikey value="Dev-Key"></td></tr>
		<tr><td class=formPrompt>https:</td><td><input type=checkbox name=with_https checked></td></tr>
		<tr><td align=center colspan=2><span class=topBlob onClick="initialLogin()">Load Zone List</span></td></tr>
		</tr>
	</form>
	</table>
</span>
</body></html>
