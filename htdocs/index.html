<!--- (c) Copyright 2019, James Stevens ... see LICENSE for details --->
<!--- Alternative license arrangements are possible, contact me for more information --->
<html>
<style type='text/css'>

html {
	color: white;
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-size:10pt;
	background-color:#666688;
	scrollbar-base-color:#666699;
	scrollbar-arrow-color:#ddddff;
	}

select {
	color: black;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 8pt;
	}

input {
	color: black;
	background-color: white;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 8pt;
	}

.inputBad {
	color: black;
	background-color: #ffd0d0;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 8pt;
	}

body {
	color: white;
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-size:10pt;
	background-color:#666688;
	scrollbar-base-color:#666699;
	scrollbar-arrow-color:#ddddff;
	}

a {
	color: darkblue;
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-weight:normal;
	font-size:10pt;
	text-decoration:none;
	}

a:hover {
	color:darkblue;
	text-decoration: underline;
	} 

form {
	margin:0px;
	}

.myBtn {
	display: inline-block;
	background-color: #d0d0ff;
	color: black;
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 10pt;
	font-weight: bold;
	border-radius: 25px;
	padding: 5px;
	padding-left: 10px;
	padding-right: 10px;
	cursor: pointer;
	margin-top: 0px;
	margin-left: 10px;
	margin-bottom: 2px;
	margin-right: 2px;
	}

.myBtn:hover {
	box-shadow: 3px 3px #444466;
	text-shadow: 1px 1px #f0f0ff;
	}

.myBtn:active {
	position: relative;
	box-shadow: none;
	text-shadow: none;
	top: 1px;
	left: 1px;
	}

td {
	padding-left: 7px;
	padding-right: 7px;
	white-space: nowrap;
	}

.zoneListItem {
	font-family: Verdana,Arial,Helvetica,sans-serif;
	font-size: 10pt;
	cursor: pointer;
	color: white;
	background-color: #666688;
	}

.zoneListItem:hover {
	background-color: #444466;
	}


.formPrompt {
	font-family:Verdana,Arial,Helvetica,sans-serif;
	font-size:10pt;
	color: white;
	text-align: right;
	}

</style>

<script language="Javascript">


console.clear();

var gbl = {
	server: null,
	apikey: null,
	with_https: true,
	thisZone: null,

	tick: "&#x2611;",
	cross: "&#x2612;",
	timer: "&#x23f3;",
	bin: "&#x2702;",
	warn: "&#x26a0;",
	};

var ctx = {
	};



function fileDownload(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}



function callApi(sfx,callback,inData)
{
	gbl.frm.style.display = "none";
	msg("Loading ... " + gbl.timer);

	p = "https"
	if (!gbl.with_https) p = "http"
	url = p + "://" + gbl.server + "/api/v1/servers/localhost/" + sfx

	okResp = 200;
	httpCmd = {
		headers: { 'X-API-Key': gbl.apikey },
		method: 'GET',
		};

	if (inData != null) {
		httpCmd.method = inData.method;
		httpCmd.body = inData.json;
		okResp = 204;
		}

	fetch(url,httpCmd).then(function(response) {
		if (response.status != okResp) {
			if (inData != null) {
				msg("");
				callback(false);
				}
			else
				showError("ERROR: " + response.status);
			return;
			}

		response.text().then(function(data) { 
			if (inData != null) 
				callback(true);
			else {
				try {
					param = JSON.parse(data); }
				catch {
					param = data; }
				msg("");
				callback(param); 
				}
		});

		}).catch(function(err) {
			showError('Fetch Error :-S', err);
			}
		);
}


//=============================================================================================
// Zone META data handling
//=============================================================================================

function zoneMeta()
{
	ctx.meta = true; topLine();
	callApi("zones/"+ctx.zone+"/metadata",zoneMetaDetails,null);
	return false;
}



function zoneMetaDetailsHTML(item)
{
	x = "<tr class=zoneListItem>"
		+ "<td>" + item.kind + "</td>"
		+ "<td>";
	for(i of item.metadata) x = x + i + "<br>";
	return x + "</td></tr>";
}



function zoneMetaDetails(data)
{
	data.sort(function(a,b) {
		if (a.kind < b.kind) return -1;
		if (a.kind > b.kind) return 1;
		return 0;
		})
	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data) x = x + zoneMetaDetailsHTML(i);
	gbl.bot.innerHTML = x + "</table>";
}



//=============================================================================================
// Zone Details Handling
//=============================================================================================


function patchRRdata()
{
	rrset = {
		name: ctx.rec.rrs.name,
		ttl: ctx.rec.rrs.ttl,
		type: ctx.rec.rrs.type,
		changetype: "REPLACE",
		records : ctx.rec.rrs.records,
		}
	return JSON.stringify({ rrsets: [ rrset ] });
}


function addNewRR()
{
	ctx.rec.rrs.records.push({ content:"", disabled: false });
	drawOneRecord();
	clickRR(ctx.rec.rrs.records.length-1);
}



function madeChange(res)
{
	// check res ??
	if (res) 
		zoneDetailsLoad(ctx.zone);
	else
		msg(gbl.warn + " Update Failed");
}



function saveRRChanges(withSave)
{
	delete ctx.needSave;
	delete ctx.rec.idx;
	topLine();

	if (withSave)
		callApi("zones/"+ctx.zone,madeChange,
			{ method: "PATCH", json: patchRRdata() } );
	else
		getZoneRecord();
}



function changeRR()
{
	newVal = document.rrForm.new.value;
	if (newVal == "") {
		if (ctx.rec.rrs.records[ctx.rec.idx].content != "") ctx.needSave = "saveRRChanges";
		ctx.rec.rrs.records.splice(ctx.rec.idx,1);
		drawOneRecord();
		}
	else if (newVal != ctx.rec.rrs.records[ctx.rec.idx].content) {
		ctx.rec.rrs.records[ctx.rec.idx].content = newVal;
		s = document.getElementById("rrs"+ctx.rec.idx);
		s.innerHTML = newVal;
		ctx.needSave = "saveRRChanges";
		}

	delete ctx.rec.idx;
	delete ctx.needCancel;
	topLine();

	return false; // cancel the form submit
}



function changeTTL()
{
	newVal = document.rrForm.new.value;
	if (newVal != ctx.rec.rrs.ttl) {
		ctx.needSave = "saveRRChanges";
		ctx.rec.rrs.ttl = newVal;
		drawOneRecord();
		}

	delete ctx.rec.ttl;
	delete ctx.needCancel;
	topLine();

	return false; // cancel the form submit
}



function clickTTL(idx)
{
	s = document.getElementById("ttl"+idx);
	if (s.innerHTML.indexOf("<form") >= 0) return;

	if ("idx" in ctx.rec) {
		drawOneRecord();
		return;
		}

	if ("ttl" in ctx.rec) return;

	ctx.rec.ttl = idx

	x = "<form onSubmit='return changeTTL();' name=rrForm>"
		+ "<input size=10 name=new value=\""+ctx.rec.rrs.ttl+"\"></form>";

	s.innerHTML = x;
	document.rrForm.new.focus();
	ctx.needCancel = "editNoRR";
	topLine();
}



function clickRR(idx)
{
	s = document.getElementById("rrs"+idx);
	if (s.innerHTML.indexOf("<form") >= 0) return;

	if ("idx" in ctx.rec) {
		if ((document.rrForm.new.value == "")&&(ctx.rec.rrs.records[ctx.rec.idx].content == ""))
			ctx.rec.rrs.records.pop();

		drawOneRecord();
		s = document.getElementById("rrs"+idx);
		}

	ctx.rec.idx = idx

	x = "<form onSubmit='return changeRR();' name=rrForm>"
		+ "<input size=50 name=new value='"+ctx.rec.rrs.records[idx].content.replace(/'/g,"&apos;")+"'>"
		+ "</form>";

	s.innerHTML = x;
	document.rrForm.new.focus();
	ctx.needCancel = "editNoRR";
	topLine();
}



function editNoRR()
{
	if ("ttl" in ctx.rec) {
		s = document.getElementById("ttl"+ctx.rec.ttl);
		s.innerHTML = ctx.rec.rrs.ttl
		}

	if ("idx" in ctx.rec) {
		if ((document.rrForm.new.value == "")&&(ctx.rec.rrs.records[ctx.rec.idx].content == "")) {
			ctx.rec.rrs.records.pop();

			if ((ctx.rec.loadedRows==0)&&(ctx.rec.rrs.records.length==0))
				return zoneDetailsLoad(ctx.zone);

			drawOneRecord();
			}
		else {
			s = document.getElementById("rrs"+ctx.rec.idx);
			s.innerHTML = ctx.rec.rrs.records[ctx.rec.idx].content;
			}
		}

	delete ctx.rec.ttl;
	delete ctx.rec.idx;
	delete ctx.needCancel;
	topLine();
}



function deleteRRitem(idx)
{
	if ("idx" in ctx.rec) return editNoRR();
	ctx.rec.rrs.records.splice(idx,1);
	ctx.needSave = "saveRRChanges";
	topLine();
	drawOneRecord();
}



function oneRecordHTML(idx)
{
	i = ctx.rec.rrs.records[idx];
	x = "<tr class=zoneListItem>"
		+ "<td width=10% onClick='deleteRRitem("+idx+");' align=center>" + gbl.bin + "</td>"
		+ "<td width=25% onClick='editNoRR();'>" + ctx.rec.rrs.name + "</td>"
		+ "<td valign=top align=right onClick='clickTTL("+idx+");'><span id=ttl"+idx+">" + ctx.rec.rrs.ttl + "</span></td>"
		+ "<td valign=top>" + ctx.rec.rrs.type + "</td>"
		+ "<td onClick='clickRR("+idx+");' width=60%><span id=rrs"+idx+">" + i.content + "</span></td>";
	return x + "</tr>";
}



function findRec(rrsets,rec)
{
	for(tag of rrsets)
		if ((tag.name == rec.name)&&(tag.type == rec.type)) return tag;

	return null;
}



function oneRecord(data)
{
	if (data.id != ctx.zone)
		return showError("ERROR: Zone does not match loaded data");

	rrs = findRec(data.rrsets,ctx.rec);

	if (rrs == null) {
		if ("rrs" in ctx.rec) {
			while ((ctx.rec.rrs.records.length > 0)&&(ctx.rec.rrs.records[ctx.rec.rrs.records.length-1].content == ""))
				ctx.rec.rrs.records.pop();
			}
		return showError("No matching data for " + ctx.rec.name + "/" + ctx.rec.type);
		}

	rrs.records.sort(function(a,b) {
		if (a.content < b.content) return -1;
		if (a.content > b.content) return 1;
		return 0;
		})

	ctx.rec.rrs = rrs;
	ctx.rec.loadedRows = rrs.records.length;

	drawOneRecord();
}



function drawOneRecord(rrs)
{
	delete ctx.rec.idx;
	delete ctx.rec.ttl;

	x = "<table width=100% border=0 cellspacing=1 cellpadding=0>";
	for(idx in ctx.rec.rrs.records) 
		x = x + oneRecordHTML(idx);
	gbl.bot.innerHTML = x + "</table>";
}



function clickZoneRecord(name,type)
{
	ctx.rec = {
		name: name,
		type: type,
		};
	delete ctx.meta;

	getZoneRecord();
}



function getZoneRecord()
{
	delete ctx.needSave;
	delete ctx.needCancel;
	topLine();
	callApi("zones/" + ctx.zone,oneRecord,null);
}


//=============================================================================================
// Zone detils code
//=============================================================================================


function doNewName()
{
	f = document.newNameForm;
	if (f.rrTTL.value == "") {
		f.rrTTL.class = "inputBad";
		return f.rrTTL.focus();
		}

	delete ctx.addRR;
	gbl.frm.style.display = "none";

	if (f.rrName.value == "")
		name = ctx.zone; 
	else 
		name = f.rrName.value + "." + ctx.zone;

	if (findRec(ctx.rrsets,{ name: name, type: f.rrType.value })!=null)
		return clickZoneRecord(name,f.rrType.value);

	ctx.rec = {
		name: name,
		type: f.rrType.value,
		rrs: {
			name: name,
			type: f.rrType.value,
			ttl: f.rrTTL.value,
			records: [ ],
			},
		};

	ctx.rec.loadedRows = 0;
	ctx.needSave = "saveRRChanges";
	addNewRR();

	return false; // prevent submit
}



function zoneNameAdd()
{
	ctx.addRR = true;
	topLine();
	gbl.bot.innerHTML = "";
	gbl.frm.style.display = "block";
	f = document.newNameForm;
	f.rrName.value = "";
	f.rrTTL.value = "";
	f.rrName.focus();
}



function zoneDetailsHTML(zone,item)
{
	x = "<tr onClick=\"clickZoneRecord('"+item.name+"','"+item.type+"');\" class=zoneListItem>"
		+ "<td valign=top>" + item.name.substr(0,item.name.length - zone.length - 1) + "</td>"
		+ "<td valign=top align=right>" + item.ttl + "</td>"
		+ "<td valign=top>" + item.type + "</td>"
		+ "<td valign=top>"

	if (item.type == "SOA")
		x = x + formatSOA(item.records[0].content);
	else {
		item.records.sort(function(a,b) {
			if (a.content < b.content) return -1;
			if (a.content > b.content) return 1;
			return 0;
			})

		for(rrs of item.records) 
			x = x + "" + rrs.content + "<br>";
		}
	return x + "</td></tr>";
}



function zoneDetails(data)
{
	data.rrsets.sort(function(a,b) {
		if ((a.name == data.id)&&(b.name == data.id)) {
			for(tag of ["SOA","NS","MX"]) {
				if (a.type == tag) return -1;
				if (b.type == tag) return 1;
				}
			}
		else {
			if (a.name == data.id) return -1;
			if (b.name == data.id) return 1;
			if (a.name < b.name) return -1;
			if (a.name > b.name) return 1;
			}
		if (a.type < b.type) return -1;
		if (a.type > b.type) return 1;
		return 0;
		})

	ctx.rrsets = data.rrsets;

	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data.rrsets) x = x + zoneDetailsHTML(data.id,i);
	gbl.bot.innerHTML = x + "</table>";
}



function zoneDetailsLoad(zone)
{
	ctx = { zone: zone };
	topLine();
	callApi("zones/" + ctx.zone,zoneDetails,null);
}



//=============================================================================================
// Search handling code
//=============================================================================================

function searchResultsHTML(item)
{
	x = "<tr class=zoneListItem";
	if (item.object_type != "zone") {
		x = x + "><td valign=top>" + item.name + "</td>"
			+ "<td valign=top align=right>" + item.ttl + "</td>"
			+ "<td valign=top>" + item.type + "</td>";

		if (item.type == "SOA")
			x = x + "<td valign=top>" + formatSOA(item.content) + "</td>";
		else
			x = x + "<td valign=top>" + item.content + "</td>"; }

	else {
		x = x + " onClick='return zoneDetailsLoad(\""+item.name+"\");'>";
		x = x + "<td>" + item.name + "</td><td colspan=3>[Zone Apex]</td>";
		}
	return x + "</tr>";
}



function searchResults(data)
{
	ctx = {}; topLine();
	if (data.length <= 0) {
		gbl.bot.innerHTML = "No search results";
		return;
		}

	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data) x = x + searchResultsHTML(i);
	gbl.bot.innerHTML = x + "</table>";
}



function searchFormSubmit()
{
	s = document.searchForm.searchTerm.value;
	document.searchForm.searchTerm.value = "";
	callApi("search-data?q=" + s,searchResults,null);
	return false;
}



//=============================================================================================
// Code to handle the list of zones
//=============================================================================================

function zoneListDetailsHTML(item) 
{
	name = item.id;
	x = "<tr class=zoneListItem onClick='zoneDetailsLoad(\""+name+"\")'>"
		+ "<td>" + name + "</td>"
		+ "<td>" + item.kind + "</td>";
	if (item.dnssec) t = gbl.tick; else t = gbl.cross;
	x = x + "<td>" + t + "</td>"
		+ "<td>" + item.serial + "</td>";
	if (item.notified_serial == item.serial) t = gbl.tick; else t = gbl.cross;
	x = x + "<td>" + t + "</td>";
	return x + "</tr>";
}



function zoneListDetails(data)
{
	data.sort(function(a,b) {
		if (a.id < b.id) return -1;
		if (a.id > b.id) return 1;;
		return 0;
		})

	x = "<table width=100% border=0 cellspacing=0 cellpadding=0>";
	for(i of data) x = x + zoneListDetailsHTML(i);
	gbl.bot.innerHTML = x + "</table>";
}



function zoneList()
{
	ctx = { }; topLine();
	callApi("zones",zoneListDetails,null);
	return false;
}


//=============================================================================================
// Zone AXFR
//=============================================================================================

function zoneAxfrData(data)
{
	name = ctx.zone.replace(/\./g,"_");
	name = name.substr(0,name.length-1) + ".txt";
	fileDownload(name,data);
}


function zoneAxfr()
{
	callApi("zones/"+ctx.zone+"/export",zoneAxfrData,null)
}


//=============================================================================================
// Common functions
//=============================================================================================


function btn(call,txt) {
	return "<span class=myBtn onClick='"+call+"; return false;'>"+txt+"</span>"
}



function topLine()
{
	gbl.frm.style.display = "none";

	x = "<table border=0 cellspacing=0 cellpadding=0 width=100%><tr><td>"
		+ btn("location.reload()",gbl.server) + btn("zoneList()","Zones");

	if ("zone" in ctx) {
		x = x + btn('zoneDetailsLoad("'+ctx.zone+'")',ctx.zone.substr(0,ctx.zone.length-1))

		if ("rec" in ctx) {
			if (ctx.rec.name == ctx.zone) name = "@"
			else
				name = ctx.rec.name.substr(0,ctx.rec.name.length - ctx.zone.length - 1);

			x = x + btn('getZoneRecord()',name+'/'+ctx.rec.type);
			}
		else {
			if ("meta" in ctx)
				x = x + btn('zoneMeta()',"META");
			}
		}

	x = x + "</td><td width=100% align=center><span id='showMsg'></span></td><td>";

	if (("zone" in ctx)&&(!("meta" in ctx))&&(!("rec" in ctx))&&(!("addRR" in ctx)))
		x = x + btn("zoneNameAdd()","Add") + btn("zoneAxfr()","AXFR") + btn('zoneMeta()',"META");

	if ("needCancel" in ctx)
		x = x + btn(ctx.needCancel+"(false)","Cancel");
	else {
		if ("rec" in ctx)
			x = x + btn("addNewRR()","Add");

		if ("needSave" in ctx)
			x = x + btn(ctx.needSave+"(false)","Cancel")
				+ btn(ctx.needSave+"(true)","Save");
		}

	x = x + "</td><td width=1 align=right><form name=searchForm onSubmit='return searchFormSubmit();'>"
		+ "<input placeholder='Search' size=30 name=searchTerm></form></td>"
		+ "</tr><table><hr>";

	gbl.top.innerHTML = x;
}



function startUp()
{
	gbl.top = document.getElementById("topSpan");
	gbl.bot = document.getElementById("lowerSpan");
	gbl.frm = document.getElementById("addName");
}



function initialLogin()
{
	f = document.loginForm;
	gbl.server = f.server.value;
	gbl.apikey = f.apikey.value;
	gbl.with_https = f.with_https.checked;
	zoneList();
}



function formatSOA(soa_txt)
{
	i = soa_txt.split(" ");
	soa = i[0] + " " + i[1] + "<br>";
	idx = 2;
	for(tag of ["serial","refresh","retry","expire","minimum"]) {
		soa = soa + "<span style='display: inline-block; width:50px'></span>";
		soa = soa + "<span style='display: inline-block; width:100px'>" + i[idx++] + "</span>;" + tag + "<br>";
		}
	return soa;
}



function showError(err)
{
	gbl.bot.innerHTML = "<h1>"+err+"</h1>";
}



function msg(myMsg)
{
	m = document.getElementById("showMsg");
	m.innerHTML = myMsg;
}




//=============================================================================================
</script>



<body onLoad="startUp();">
<span id="topSpan"></span>
<span id="lowerSpan">
	<table align=center>
	<form action="/" name=loginForm>
		<tr><td class=formPrompt>Server:</td><td><input name=server value="pdnsdev.jrcs.net"></td></tr>
		<tr><td class=formPrompt>Key:</td><td><input type=password name=apikey value="Dev-Key"></td></tr>
		<tr><td class=formPrompt>https:</td><td><input type=checkbox name=with_https checked></td></tr>
		<tr><td align=center colspan=2><span class=myBtn onClick="initialLogin()">Load Zone List</span></td></tr>
		</tr>
	</form>
	</table>
</span>

<span id=addName style="display: none;">
	<table align=center>
	<form action="/" name=newNameForm onSubmit="return doNewName();">
		<tr><td class=formPrompt>Host name:</td><td><input name=rrName></td></tr>
		<tr><td class=formPrompt>RR Type:</td><td><select name=rrType>
		<option>A<option>AAAA<option>MX<option>NS<option>TXT

		<option>A6<option>ADDR<option>AFSDB<option>ALIAS
		<option>ANY<option>AXFR<option>CAA<option>CDNSKEY<option>CDS<option>CERT
		<option>CNAME<option>DHCID<option>DLV<option>DNAME<option>DNSKEY<option>DS
		<option>EUI48<option>EUI64<option>HINFO<option>IPSECKEY<option>IXFR<option>KEY
		<option>KX<option>LOC<option>LUA<option>MAILA<option>MAILB<option>MB
		<option>MG<option>MINFO<option>MR<option>MX<option>NAPTR<option>NS
		<option>OPENPGPKEY<option>OPT<option>PTR
		<option>RKEY<option>RP<option>RRSIG<option>SIG<option>SMIMEA<option>SOA
		<option>SPF<option>SRV<option>SSHFP<option>TKEY<option>TLSA<option>TXT
		<option>URI<option>WKS

		</select></td></tr>
		<tr><td class=formPrompt>TTL:</td><td><input name=rrTTL></td></tr>
		<tr><td align=center colspan=2><span class=myBtn onClick="zoneDetailsLoad(ctx.zone);">Cancel</span><span class=myBtn onClick="doNewName();">Add Record</span></td></tr>
		</tr>
	</form>
	</table>
</span>

</body></html>
